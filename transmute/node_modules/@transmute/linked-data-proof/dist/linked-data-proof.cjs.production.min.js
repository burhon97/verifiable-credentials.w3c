"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,r=(e=require("jsonld"))&&"object"==typeof e&&"default"in e?e.default:e,t=require("serialize-error"),o=function(){function e(e){var r=void 0===e?{}:e,t=r.term,o=r.date,n=r.maxTimestampDelta,i=void 0===n?Infinity:n;if(void 0===t)throw new Error('"term" is required.');if(void 0!==i&&"number"!=typeof i)throw new TypeError('"maxTimestampDelta" must be a number.');if(this.term=t,void 0!==o&&(this.date=new Date(o),isNaN(this.date)))throw TypeError('"date" "'+o+'" is not a valid date.');this.maxTimestampDelta=i}var r=e.prototype;return r.validate=function(e,r){try{try{if(Infinity!==this.maxTimestampDelta){var t=(this.date||new Date).getTime(),o=1e3*this.maxTimestampDelta,n=new Date(e.created).getTime();if(!(n>=t-o&&n<=t+o))throw new Error("The proof's created timestamp is out of range.")}return Promise.resolve({valid:!0})}catch(e){return Promise.resolve({valid:!1,error:e})}}catch(e){return Promise.reject(e)}},r.update=function(e,r){try{return e.proofPurpose=this.term,Promise.resolve(e)}catch(e){return Promise.reject(e)}},r.match=function(e){try{return Promise.resolve(e.proofPurpose===this.term)}catch(e){return Promise.reject(e)}},e}();function n(){return(n=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)}function i(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,r){return(u=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function c(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function s(e,r,t){return(s=c()?Reflect.construct:function(e,r,t){var o=[null];o.push.apply(o,r);var n=new(Function.bind.apply(e,o));return t&&u(n,t.prototype),n}).apply(null,arguments)}function p(e){var r="function"==typeof Map?new Map:void 0;return(p=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return s(e,arguments,a(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),u(t,e)})(e)}function f(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,o=new Array(r);t<r;t++)o[t]=e[t];return o}function l(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var d=function(e){function t(r){var t=void 0===r?{}:r,o=t.maxTimestampDelta;return e.call(this,{term:t.term,date:t.date,maxTimestampDelta:void 0===o?Infinity:o})||this}return i(t,e),t.prototype.validate=function(t,o){try{var n=this;return Promise.resolve(l((function(){return Promise.resolve(e.prototype.validate.call(n,t,o)).then((function(e){if(!e.valid)throw e.error;var t=o.verificationMethod,i=t.id;return Promise.resolve((0,o.documentLoader)(t.controller.id)).then((function(o){e.controller=o.document;var a=r.getValues(e.controller,n.term);if(e.valid=a.some((function(e){return e===i||e==="#"+i.split("#").pop()||"object"==typeof e&&e.id===i})),!e.valid)throw new Error('Verification method "'+t.id+'" not authorized by controller for proof purpose "'+n.term+'".');return e}))}))}),(function(e){return{valid:!1,error:e}})))}catch(e){return Promise.reject(e)}},t}(o),m={ProofPurpose:o,ControllerProofPurpose:d,AssertionProofPurpose:function(e){function r(r){var t=void 0===r?{}:r,o=t.term,n=t.maxTimestampDelta;return e.call(this,{term:void 0===o?"assertionMethod":o,controller:t.controller,date:t.date,maxTimestampDelta:void 0===n?Infinity:n})||this}return i(r,e),r}(d),AuthenticationProofPurpose:function(e){function r(r){var t,o=void 0===r?{}:r,n=o.term,i=o.challenge,a=o.domain,u=o.maxTimestampDelta;if(t=e.call(this,{term:void 0===n?"authentication":n,controller:o.controller,date:o.date,maxTimestampDelta:void 0===u?Infinity:u})||this,"string"!=typeof i)throw new TypeError('"challenge" must be a string.');if(void 0!==a&&"string"!=typeof a)throw new TypeError('"domain" must be a string.');return t.challenge=i,t.domain=a,t}i(r,e);var t=r.prototype;return t.validate=function(r,t){var o=t.verificationMethod,n=t.documentLoader,i=t.expansionMap;try{try{if(r.challenge!==this.challenge)throw new Error('The challenge is not as expected; challenge="'+r.challenge+'", expected="'+this.challenge+'"');if(void 0!==this.domain&&r.domain!==this.domain)throw new Error('The domain is not as expected; domain="'+r.domain+'", expected="'+this.domain+'"');return Promise.resolve(e.prototype.validate.call(this,r,{verificationMethod:o,documentLoader:n,expansionMap:i}))}catch(e){return Promise.resolve({valid:!1,error:e})}}catch(e){return Promise.reject(e)}},t.update=function(r,t){try{var o=this;return Promise.resolve(e.prototype.update.call(o,r,t)).then((function(e){return(r=e).challenge=o.challenge,void 0!==o.domain&&(r.domain=o.domain),r}))}catch(e){return Promise.reject(e)}},r}(d)},h=function(e){if(e.unmappedProperty)throw new Error('The property "'+e.unmappedProperty+'" in the input was not defined in the context.')},v=function(){function e(){var e=this,o=this;this._getProofs=function(e){var t=e.document,o=e.documentLoader,i=e.expansionMap,a=e.compactProof;try{var u,c=function(){if(u=r.getValues(t,s),delete t[s],0===u.length)throw new Error("No matching proofs found in the given document.");var e=["BbsBlsSignatureProof2020"],o=t["@context"];return{proofSet:u=u.map((function(r){return n({"@context":e.includes(r.type)?["https://w3id.org/security/v2"]:o},r)})),document:t}},s="proof",p=function(){if(a)return Promise.resolve(r.compact(t,t["@context"],{documentLoader:o,expansionMap:i,compactToRelative:!1})).then((function(e){t=e}))}();return Promise.resolve(p&&p.then?p.then(c):c())}catch(e){return Promise.reject(e)}},this._verify=function(r){var t=r.document,o=r.suites,i=r.proofSet,a=r.purpose,u=r.documentLoader,c=r.expansionMap,s=r.compactProof;try{return Promise.resolve(Promise.all(i.map((function(e){return a.match(e,{document:t,documentLoader:u,expansionMap:c})})))).then((function(r){var p=i.filter((function(e,t){return r[t]}));return 0===p.length?[]:Promise.resolve(Promise.all(p.map((function(e){try{for(var r,n=function(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return f(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?f(e,void 0):void 0}}(e))){t&&(e=t);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}(o);!(r=n()).done;){var i=r.value;if(i.type.replace("sec:","")===e.type)return Promise.resolve(i.verifyProof({proof:e,document:t,purpose:a,documentLoader:u,expansionMap:c,compactProof:s}).catch((function(e){return{verified:!1,error:e}})))}return Promise.resolve()}catch(e){return Promise.reject(e)}})))).then((function(r){return r.map((function(r,t){return r?(r.error&&e._addToJSON(r.error),n({proof:p[t]},r)):null})).filter((function(e){return e}))}))}))}catch(e){return Promise.reject(e)}},this._addToJSON=function(e){Object.defineProperty(e,"toJSON",{value:function(){return t.serializeError(this)},configurable:!0,writable:!0})},this.verify=function(e,r){var t=void 0===r?{}:r,n=t.suite,i=t.purpose,a=t.documentLoader,u=t.expansionMap,c=t.compactProof,s=void 0!==c&&c;try{if(!n)throw new TypeError('"options.suite" is required.');if(!i)throw new TypeError('"options.purpose" is required.');var p=Array.isArray(n)?n:[n];if(0===p.length)throw new TypeError("At least one suite is required.");if(p.some((function(e){return e.legacy})))throw new TypeError("Legacy suites are no longer supported.");if(!a)throw new TypeError('"options.documentLoader" is required.');return!1!==u&&(u=h),Promise.resolve(l((function(){function r(){return Promise.resolve(o._getProofs({document:e,documentLoader:a,expansionMap:u,compactProof:s})).then((function(r){return e=r.document,Promise.resolve(o._verify({document:e,suites:p,proofSet:r.proofSet,purpose:i,documentLoader:a,expansionMap:u,compactProof:s})).then((function(e){if(0===e.length)throw new Error("Could not verify any proofs; no proofs matched the required suite and purpose.");var r=e.some((function(e){return e.verified}));if(!r){var t,o=(t=[]).concat.apply(t,e.filter((function(e){return e.error})).map((function(e){return e.error}))),n={verified:r,results:e};return o.length>0&&(n.error=o),n}return{verified:r,results:e}}))}))}var t=function(){if("string"==typeof e)return Promise.resolve(a(e)).then((function(r){e=r}));e=JSON.parse(JSON.stringify(e))}();return t&&t.then?t.then(r):r()}),(function(e){return o._addToJSON(e),{verified:!1,error:e}})))}catch(e){return Promise.reject(e)}}}return e.prototype.add=function(e,t){var o=void 0===t?{compactProof:!0}:t,i=o.suite,a=o.purpose,u=o.documentLoader,c=o.expansionMap,s=o.compactProof,p=void 0===s||s;try{var f=function(){var t=n({},e);return delete t.proof,Promise.resolve(i.createProof({document:t,purpose:a,documentLoader:u,expansionMap:c,compactProof:p})).then((function(t){return delete t["@context"],t.type=t.type.replace("sec:",""),r.addValue(e,"proof",t),e}))};if(!i)throw new TypeError('"options.suite" is required.');if(!u)throw new TypeError('"options.documentLoader" is required.');if(!a)throw new TypeError('"options.purpose" is required.');if(i.legacy)throw new TypeError("Legacy suites are no longer supported.");!1!==c&&(c=h);var l=function(){if("string"==typeof e)return Promise.resolve(u(e)).then((function(r){e=r}))}();return Promise.resolve(l&&l.then?l.then(f):f())}catch(e){return Promise.reject(e)}},e}(),y=function(e){function r(r){var t;return(t=e.call(this,"Verification error(s).")||this).name="VerificationError",t.errors=[].concat(r),t}return i(r,e),r}(p(Error));exports.purposes=m,exports.sign=function(e,r){var t=void 0===r?{compactProof:!0}:r,o=t.suite,n=t.purpose,i=t.documentLoader,a=t.expansionMap,u=t.compactProof;try{return Promise.resolve(l((function(){return Promise.resolve((new v).add(e,{suite:o,purpose:n,documentLoader:i,expansionMap:a,compactProof:u}))}),(function(e){if(!i&&"jsonld.InvalidUrl"===e.name){var r=new Error('A URL "'+e.details.url+'" could not be fetched;you need to pass "documentLoader" or resolve the URL before calling "sign".');throw r.cause=e,r}throw e})))}catch(e){return Promise.reject(e)}},exports.verify=function(e,r){var t=void 0===r?{}:r,o=t.suite,n=t.purpose,i=t.documentLoader,a=t.expansionMap,u=t.compactProof;try{return Promise.resolve((new v).verify(e,{suite:o,purpose:n,documentLoader:i,expansionMap:a,compactProof:u})).then((function(e){var r=e.error;if(r)if(i||"jsonld.InvalidUrl"!==r.name)e.error=new y(r);else{var t=new Error('A URL "'+r.details.url+'" could not be fetched; you need to pass "documentLoader" or resolve the URL before calling "verify".');e.error=new y(t)}return e}))}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=linked-data-proof.cjs.production.min.js.map
