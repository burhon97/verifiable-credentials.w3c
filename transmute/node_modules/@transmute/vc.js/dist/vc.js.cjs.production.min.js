"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@transmute/linked-data-proof"),t=e(require("jsonld")),n=require("@transmute/jsonld-schema"),i=e(require("moment")),o=require("@transmute/json-web-signature");function a(){return(a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function s(e,r){return(s=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}var u=new RegExp("^([0-9]{4})-([0-9]{2})-([0-9]{2})([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(.[0-9]+)?)?(([Zz]|([+-])([0-9]{2}):([0-9]{2})))?"),c=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-6]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,f=/[+-]\d\d:\d\d$/,d=function(e,r){void 0===r&&(r=!1);var t={valid:!1,warnings:[]};c.test(e)||t.warnings.push(e+" is not a legal ISO 8601 Date Time."),u.test(e)||t.warnings.push(e+" is not a legal RFC 3339 Date Time."),i.suppressDeprecationWarnings=!0;var n=e,o=!1;try{if("60"===n.split(":")[2].substring(0,2)){n=n.replace("60","59");var a=new Date(n);a.setSeconds(new Date(n).getSeconds()+1),n=a.toISOString(),o=!0}}catch(e){}return null===i(n).toISOString()&&t.warnings.push(e+" could not be parsed and serialized as ISO 8601 Date Time."),r&&(o&&t.warnings.push(e+" lost leap second information."),f.test(e)&&t.warnings.push(e+" lost timezone offset information."),new Date(n).getMilliseconds()&&t.warnings.push(e+" lost millisecond information.")),i.suppressDeprecationWarnings=!1,t.valid=0===t.warnings.length,t};function l(e){return"string"==typeof e?e:"id"in e?e.id:void 0}var v=function(e,r){try{var i=r.documentLoader,o=r.strict||"warn";if("ignore"===r.strict)return Promise.resolve(void 0);var a=!1;if("string"==typeof e){var s=e.split("."),u=s[1];if(!JSON.parse(Buffer.from(s[0],"base64").toString()).alg)throw new Error("alg is required in JWT header");var c=JSON.parse(Buffer.from(u,"base64").toString());e=c.vc,a=!0}if(!e["@context"])throw new Error("Verifiable Credentials MUST include a @context property.");if(!i)throw new TypeError('"documentLoader" parameter is required for checking presentations.');return Promise.resolve(n.check({input:e,documentLoader:i})).then((function(r){if(!r.ok)throw new Error("credential is not valid JSON-LD: "+JSON.stringify(r.error,null,2));if(!e.type)throw new Error('"type" property is required.');if(!t.getValues(e,"type").includes("VerifiableCredential"))throw new Error('"type" must include `VerifiableCredential`.');if(!e.credentialSubject)throw new Error('"credentialSubject" property is required.');if(!e.issuer)throw new Error('"issuer" property is required.');if(t.getValues(e,"issuanceDate").length>1)throw new Error('"issuanceDate" property can only have one value.');if(!e.issuanceDate)throw new Error('"issuanceDate" property is required.');if("issuanceDate"in e){var n=d(e.issuanceDate,a);if(!n.valid){var i=["issuanceDate is not valid: "+JSON.stringify(n.warnings,null,2),"issuanceDate must be XML Datestring as defined in spec: https://w3c.github.io/vc-data-model/#issuance-date"].join("\n");if("warn"==o&&console.warn(i),"throw"==o)throw new Error(i)}}if("expirationDate"in e){var s=d(e.expirationDate,a);if(!s.valid){var u=["expirationDate is not valid: "+JSON.stringify(s.warnings,null,2),"expirationDate must be XML Datestring as defined in spec: https://w3c.github.io/vc-data-model/#expiration"].join("\n");if("warn"==o&&console.warn(u),"throw"==o)throw new Error(u)}}if(t.getValues(e,"issuer").length>1)throw new Error('"issuer" property can only have one value.');if("issuer"in e){var c=l(e.issuer);if(!c)throw new Error('"issuer" id is required.');if(!c.includes(":"))throw new Error('"issuer" id must be a URL: '+c)}if("credentialStatus"in e){if(!e.credentialStatus.id)throw new Error('"credentialStatus" must include an id.');if(!e.credentialStatus.type)throw new Error('"credentialStatus" must include a type.')}t.getValues(e,"evidence").forEach((function(e){var r=l(e);if(r&&!r.includes(":"))throw new Error('"evidence" id must be a URL: '+e)}))}))}catch(e){return Promise.reject(e)}};function h(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var m=function(e){var r,t;function n(r){var t=void 0===r?{}:r;return e.call(this,{controller:t.controller,date:t.date,maxTimestampDelta:t.maxTimestampDelta})||this}return t=e,(r=n).prototype=Object.create(t.prototype),r.prototype.constructor=r,s(r,t),n.prototype.validate=function(r,t){var n=t.document,i=t.suite,o=t.verificationMethod,a=t.documentLoader,s=t.expansionMap;try{var u=this;return Promise.resolve(h((function(){return Promise.resolve(e.prototype.validate.call(u,r,{document:n,suite:i,verificationMethod:o,documentLoader:a,expansionMap:s})).then((function(e){if(!e.valid)throw e.error;var r="string"==typeof n.issuer?n.issuer:n.issuer.id;if(!r)throw new Error("Credential issuer is required.");if(e.controller.id!==r)throw new Error("Credential issuer must match the verification method controller.");return{valid:!0}}))}),(function(e){return{valid:!1,error:e}})))}catch(e){return Promise.reject(e)}},n}(r.purposes.AssertionProofPurpose),p=function(e){try{var t=e.credential,n=e.suite,i=e.documentLoader,o=e.strict||"warn";if(!t)throw new TypeError('"credential" parameter is required for issuing.');return Promise.resolve(v(t,{documentLoader:i,strict:o})).then((function(){if(!i)throw new TypeError('"documentLoader" parameter is required for issuing.');if(!n)throw new TypeError('"suite" parameter is required for issuing.');if(!n.verificationMethod)throw new TypeError('"suite.verificationMethod" property is required.');var o=new m;return r.sign(t,a({purpose:o},e))}))}catch(e){return Promise.reject(e)}},w=function(e){try{var t=e.credential,n=e.checkStatus,i=e.documentLoader;if(void 0!==e.expansionMap)throw new Error("The default options are not being used.");return Promise.resolve(h((function(){if(!t)throw new TypeError('A "credential" property is required for verifying.');return Promise.resolve(v(t,{documentLoader:i})).then((function(){if(t.credentialStatus&&"function"!=typeof e.checkStatus)throw new TypeError('A "checkStatus" function must be given to verify credentials with "credentialStatus".');var i=new m;return Promise.resolve(r.verify(t,a({},e,{purpose:i,compactProof:!1}))).then((function(r){if(!r.verified)return r;var i=function(){if(t.credentialStatus)return Promise.resolve(n(e)).then((function(e){r.statusResult=e,r.statusResult.verified||(r.verified=!1)}))}();return i&&i.then?i.then((function(){return r})):r}))}))}),(function(e){return{verified:!1,results:[{credential:t,verified:!1,error:e}],error:e}})))}catch(e){return Promise.reject(e)}},y=function(e,r){try{var i=r.documentLoader,o=r.domain,a=r.challenge,s=r.strict||"warn";if("string"==typeof e){var u=e.split("."),c=u[1];if(!JSON.parse(Buffer.from(u[0],"base64").toString()).alg)throw new Error("alg is required in JWT header");var f=JSON.parse(Buffer.from(c,"base64").toString());if(e=f.vp,f.aud&&f.aud!==o)throw new Error('"aud" and "domain" does not match this verifiable presentation');if(f.nonce&&f.nonce!==a)throw new Error('"nonce" and "challenge" does not match this verifiable presentation')}if(!e["@context"])throw new Error("Verifiable Presentations MUST include a @context property.");if(!i)throw new TypeError('"documentLoader" parameter is required for checking presentations.');return Promise.resolve(n.check({input:e,documentLoader:i})).then((function(r){if(!r.ok)throw new Error("presentation is not valid JSON-LD: "+JSON.stringify(r.error,null,2));if(!t.getValues(e,"type").includes("VerifiablePresentation"))throw new Error('"type" must include "VerifiablePresentation".');var n=function(){if(e.verifiableCredential){var r=Array.isArray(e.verifiableCredential)?e.verifiableCredential:[e.verifiableCredential];return Promise.resolve(Promise.all(r.map((function(e){try{return Promise.resolve(v(e,{documentLoader:i,strict:s})).then((function(){}))}catch(e){return Promise.reject(e)}})))).then((function(){}))}}();if(n&&n.then)return n.then((function(){}))}))}catch(e){return Promise.reject(e)}},P=function(e){try{var t=e.presentation,n=e.domain,i=e.challenge;return Promise.resolve(y(t,{documentLoader:e.documentLoader,strict:e.strict||"warn"})).then((function(){var o=new r.purposes.AuthenticationProofPurpose({domain:n,challenge:i});return r.sign(t,a({},e,{purpose:o}))}))}catch(e){return Promise.reject(e)}},g=function(e,r){try{var t=e.split(".").splice(0,1).map((function(e){return JSON.parse(Buffer.from(e,"base64").toString())}))[0];if(!t.kid)throw new Error('Transmute requires "kid" in vc-jwt headers. Otherwise key dereferencing is not always possible.');var n=Array.isArray(r.suite)?r.suite[0]:r.suite;return Promise.resolve(n.getVerificationMethod({proof:{verificationMethod:t.kid},documentLoader:r.documentLoader,instance:!0})).then((function(e){if(!e||!e.useJwa)throw new Error('Transmute requires "suite.getVerificationMethod" to return a key instance with member useJwa.');var r=o.JsonWebKey.from;return Promise.resolve(e.export({type:"JsonWebKey2020"})).then((function(e){return Promise.resolve(r.call(o.JsonWebKey,e,{detached:!1})).then((function(e){return e.verifier()}))}))}))}catch(e){return Promise.reject(e)}},b=function(e){var r=e.split("."),t=r[2],n=[r[0],r[1]].map((function(e){return JSON.parse(Buffer.from(e,"base64").toString())}));return{header:n[0],payload:n[1],signature:t}},S=function(e,r){try{var t=r.verifier;return Promise.resolve(v(e,{documentLoader:r.documentLoader,strict:r.strict||"warn"})).then((function(){return Promise.resolve(t.verify({signature:e}))}))}catch(e){return Promise.reject(e)}},E=function(e){try{var t=function(t){if(n)return t;function i(){function t(){return d.presentation&&!d.credentials&&(d.verified=d.presentation.verified),d.presentation&&d.credentials&&(d.verified=d.presentation.verified&&d.credentials.verified),d}var n=function(){if(c.proof){var t=new r.purposes.AuthenticationProofPurpose({domain:o,challenge:s});return Promise.resolve(r.verify(c,a({},e,{purpose:t}))).then((function(e){d.presentation=e}))}d.presentation=d.credentials}();return n&&n.then?n.then(t):t()}if(!c.proof&&!c.verifiableCredential||c.verifiableCredential&&0===c.verifiableCredential.length)throw new Error('presentation MUST contain "proof" or "verifiableCredential"');if(!c.proof){var f='presentation MUST contain "proof" when strict';if("warn"==u&&console.warn(f),"throw"==u)throw new Error(f)}var d={verified:!1},l=function(){if(c.verifiableCredential&&c.verifiableCredential.length)return Promise.resolve(function(e,r){try{var t={verified:!1};return Promise.resolve(Promise.all(e.verifiableCredential.map((function(e){try{var t=function(t){if(n)return t;if(e.credentialStatus&&!r.checkStatus)throw new Error("options.checkStatus is required to verify presentation of revocable credentials.");return Promise.resolve(w(a({credential:e},r))).then((function(r){return a({credentialId:e.id},r)}))},n=!1,i=function(){if(!e["@context"])return Promise.resolve(g(e,r)).then((function(t){return Promise.resolve(S(e,a({},r,{verifier:t}))).then((function(r){var t=b(e);return n=!0,{credentialId:t.payload.vc.id||void 0,verified:r}}))}))}();return Promise.resolve(i&&i.then?i.then(t):t(i))}catch(e){return Promise.reject(e)}})))).then((function(e){return t.verified=e.every((function(e){return e.verified})),t.results=e,t}))}catch(e){return Promise.reject(e)}}(c,e)).then((function(e){d.credentials=e,e.verified||(d.verified=!1)}))}();return l&&l.then?l.then(i):i()},n=!1,i=e.documentLoader,o=e.domain,s=e.challenge,u=e.strict||"warn",c=e.presentation;if(!i)throw new TypeError('"documentLoader" parameter is required for verifying.');if(!c)throw new TypeError('A "presentation" property is required for verifying.');var f=h((function(){return Promise.resolve(y(c,{documentLoader:i,strict:u})).then((function(){}))}),(function(e){return n=!0,{verified:!1,presentation:e}}));return Promise.resolve(f&&f.then?f.then(t):t(f))}catch(e){return Promise.reject(e)}},j={__proto__:null,createVerifiableCredential:p,verifyVerifiableCredential:w,createVerifiablePresentation:P,verifyVerifiablePresentation:E},L=function(e,r){try{var t=r.documentLoader,n=r.strict||"warn";if(!e.issuer)throw new Error("Issuer is a required field.");return Promise.resolve(v(e,{documentLoader:t,strict:n})).then((function(){var r={iss:e.issuer.id?e.issuer.id:e.issuer,sub:e.credentialSubject.id?e.credentialSubject.id:e.credentialSubject,vc:e,jti:e.id,nbf:i(e.issuanceDate).unix()};return e.expirationDate&&(r.exp=i(e.expirationDate).unix()),r}))}catch(e){return Promise.reject(e)}},x=function(e,r){try{var t=r.documentLoader,n=r.domain,i=r.challenge,o=r.strict||"warn";if(!i)throw new Error('"challenge" is required to create verifiable presentations (it will be used for the "nonce" value)');return Promise.resolve(y(e,{documentLoader:t,strict:o,domain:n,challenge:i})).then((function(){var r={};if(e.holder){var t=e.holder.id?e.holder.id:e.holder;r.iss=t,r.sub=t}return r.vp=e,n&&(r.aud=n),i&&(r.nonce=i),r}))}catch(e){return Promise.reject(e)}},D=["proof"],J={credential:{create:function(e){try{var r=function(){var r=function(){if(e.format.includes("vc-jwt")){var r=(Array.isArray(e.suite)?e.suite[0]:e.suite).key;if(!r||!r.useJwa)throw new Error("Cannot create credential when suite does not contain a key that supports useJwa.");var n=o.JsonWebKey.from;return Promise.resolve(r.export({type:"JsonWebKey2020",privateKey:!0})).then((function(i){return Promise.resolve(n.call(o.JsonWebKey,i,{detached:!1,header:{kid:r.id}})).then((function(r){var n=r.signer();return Promise.resolve(L(e.credential,e)).then((function(e){var r=t.items,i=r.push;return Promise.resolve(n.sign({data:e})).then((function(e){i.call(r,e)}))}))}))}))}}();return r&&r.then?r.then((function(e){return t})):t},t={items:[]};e.format||(e.format=["vc"]);var n=function(){if(e.format.includes("vc")){var r=t.items,n=r.push;return Promise.resolve(p({credential:e.credential,suite:e.suite,documentLoader:e.documentLoader})).then((function(e){n.call(r,e)}))}}();return Promise.resolve(n&&n.then?n.then(r):r())}catch(e){return Promise.reject(e)}},derive:function(e){try{var r={items:[]};e.format||(e.format=["vc"]);var t=e.credential,n=e.frame,i=e.suite,o=e.documentLoader,s=t.proof,u=function(e,r){if(null==e)return{};var t,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r.indexOf(t=o[n])>=0||(i[t]=e[t]);return i}(t,D);if(!i.deriveProof)throw new Error("Suite requires deriveProof");return Promise.resolve(i.deriveProof({document:u,proof:a({},s,{"@context":u["@context"]}),revealDocument:n,documentLoader:o})).then((function(e){var t=a({},e.document,{proof:e.proof});return delete t.proof["@context"],r.items.push(t),r}))}catch(e){return Promise.reject(e)}},verify:function(e){try{var r=function(){var r=function(){if(e.format.includes("vc-jwt")&&!e.credential["@context"])return Promise.resolve(g(e.credential,e)).then((function(r){return Promise.resolve(r.verify({signature:e.credential})).then((function(e){t.verified=e}))}))}();return r&&r.then?r.then((function(){return t})):t},t={verified:!1};e.format||(e.format=["vc"]);var n=function(){if(e.format.includes("vc")&&e.credential["@context"])return Promise.resolve(w({credential:e.credential,suite:e.suite,documentLoader:e.documentLoader,checkStatus:e.checkStatus,expansionMap:e.expansionMap})).then((function(e){t.verified=e.verified,t.verified||(t.error=[],e&&e.statusResult&&!e.statusResult.verified&&t.error.push({statusResult:e.statusResult}),e&&e.results[0]&&!e.results[0].verified&&t.error.push({proofResult:e.results[0].verified}),e.error&&t.error.push(e.error))}))}();return Promise.resolve(n&&n.then?n.then(r):r())}catch(e){return Promise.reject(e)}}},presentation:{create:function(e){try{var r=function(){var r=function(){if(e.format.includes("vp-jwt")){var r=(Array.isArray(e.suite)?e.suite[0]:e.suite).key;if(!r||!r.useJwa)throw new Error("Cannot create credential when suite does not contain a key that supports useJwa.");var n=o.JsonWebKey.from;return Promise.resolve(r.export({type:"JsonWebKey2020",privateKey:!0})).then((function(i){return Promise.resolve(n.call(o.JsonWebKey,i,{detached:!1,header:{kid:r.id}})).then((function(r){var n=r.signer();return Promise.resolve(x(e.presentation,e)).then((function(e){var r=t.items,i=r.push;return Promise.resolve(n.sign({data:e})).then((function(e){i.call(r,e)}))}))}))}))}}();return r&&r.then?r.then((function(e){return t})):t},t={items:[]};e.format||(e.format=["vp"]);var n=function(){if(e.format.includes("vp")){var r=t.items,n=r.push;return Promise.resolve(P({presentation:e.presentation,suite:e.suite,domain:e.domain,challenge:e.challenge,documentLoader:e.documentLoader})).then((function(e){n.call(r,e)}))}}();return Promise.resolve(n&&n.then?n.then(r):r())}catch(e){return Promise.reject(e)}},verify:function(e){try{var r={verified:!1};if(e.format||(e.format=["vp"]),e.format.includes("vp")&&e.presentation["@context"])return Promise.resolve(E({presentation:e.presentation,suite:e.suite,domain:e.domain,challenge:e.challenge,checkStatus:e.checkStatus,documentLoader:e.documentLoader}));var t=function(){if(e.format.includes("vp-jwt")&&!e.presentation["@context"])return Promise.resolve(g(e.presentation,e)).then((function(t){return Promise.resolve(t.verify({signature:e.presentation})).then((function(e){r.verified=e}))}))}();return Promise.resolve(t&&t.then?t.then((function(){return r})):r)}catch(e){return Promise.reject(e)}}},jwt:{decode:b}};exports.jwt={__proto__:null,createVcPayload:L,createVerifiableCredential:function(e,r){try{var t=r.signer;return Promise.resolve(L(e,r)).then((function(e){return Promise.resolve(t.sign({data:e}))}))}catch(e){return Promise.reject(e)}},verifyVerifiableCredential:S,createVpPayload:x,createVerifiablePresentation:function(e,r){try{var t=r.signer;return Promise.resolve(x(e,r)).then((function(e){return Promise.resolve(t.sign({data:e}))}))}catch(e){return Promise.reject(e)}},verifyVerifiablePresentation:function(e,r){try{var t=r.verifier;return Promise.resolve(y(e,{documentLoader:r.documentLoader,strict:r.strict||"warn",domain:r.domain,challenge:r.challenge})).then((function(){return Promise.resolve(t.verify({signature:e}))}))}catch(e){return Promise.reject(e)}}},exports.ld=j,exports.verifiable=J;
//# sourceMappingURL=vc.js.cjs.production.min.js.map
