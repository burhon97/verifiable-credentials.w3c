"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,r=require("@peculiar/webcrypto"),t=(e=require("big-integer"))&&"object"==typeof e&&"default"in e?e.default:e,n=require("tslib"),a=require("@transmute/ld-key-pair");function o(e,r,t,n,a,o,i){try{var u=e[o](i),c=u.value}catch(e){return void t(e)}u.done?r(c):Promise.resolve(c).then(n,a)}function i(e){return function(){var r=this,t=arguments;return new Promise((function(n,a){var i=e.apply(r,t);function u(e){o(i,n,a,u,c,"next",e)}function c(e){o(i,n,a,u,c,"throw",e)}u(void 0)}))}}function u(){return(u=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}var c,s=(function(e){var r=function(e){var r=Object.prototype,t=r.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function u(e,r,t){return Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}),e[r]}try{u({},"")}catch(e){u=function(e,r,t){return e[r]=t}}function c(e,r,t,n){var a=Object.create((r&&r.prototype instanceof p?r:p).prototype),o=new K(n||[]);return a._invoke=function(e,r,t){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(t.method=a,t.arg=o;;){var i=t.delegate;if(i){var u=g(i,t);if(u){if(u===f)continue;return u}}if("next"===t.method)t.sent=t._sent=t.arg;else if("throw"===t.method){if("suspendedStart"===n)throw n="completed",t.arg;t.dispatchException(t.arg)}else"return"===t.method&&t.abrupt("return",t.arg);n="executing";var c=s(e,r,t);if("normal"===c.type){if(n=t.done?"completed":"suspendedYield",c.arg===f)continue;return{value:c.arg,done:t.done}}"throw"===c.type&&(n="completed",t.method="throw",t.arg=c.arg)}}}(e,t,o),a}function s(e,r,t){try{return{type:"normal",arg:e.call(r,t)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var f={};function p(){}function y(){}function l(){}var v={};v[a]=function(){return this};var h=Object.getPrototypeOf,d=h&&h(h(S([])));d&&d!==r&&t.call(d,a)&&(v=d);var w=l.prototype=p.prototype=Object.create(v);function b(e){["next","throw","return"].forEach((function(r){u(e,r,(function(e){return this._invoke(r,e)}))}))}function m(e,r){var n;this._invoke=function(a,o){function i(){return new r((function(n,i){!function n(a,o,i,u){var c=s(e[a],e,o);if("throw"!==c.type){var f=c.arg,p=f.value;return p&&"object"==typeof p&&t.call(p,"__await")?r.resolve(p.__await).then((function(e){n("next",e,i,u)}),(function(e){n("throw",e,i,u)})):r.resolve(p).then((function(e){f.value=e,i(f)}),(function(e){return n("throw",e,i,u)}))}u(c.arg)}(a,o,n,i)}))}return n=n?n.then(i,i):i()}}function g(e,r){var t=e.iterator[r.method];if(void 0===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=void 0,g(e,r),"throw"===r.method))return f;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var n=s(t,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,f;var a=n.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,f):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,f)}function x(e){var r={tryLoc:e[0]};1 in e&&(r.catchLoc=e[1]),2 in e&&(r.finallyLoc=e[2],r.afterLoc=e[3]),this.tryEntries.push(r)}function k(e){var r=e.completion||{};r.type="normal",delete r.arg,e.completion=r}function K(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function S(e){if(e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function r(){for(;++n<e.length;)if(t.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=void 0,r.done=!0,r};return o.next=o}}return{next:E}}function E(){return{value:void 0,done:!0}}return y.prototype=w.constructor=l,l.constructor=y,y.displayName=u(l,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===y||"GeneratorFunction"===(r.displayName||r.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,u(e,i,"GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},b(m.prototype),m.prototype[o]=function(){return this},e.AsyncIterator=m,e.async=function(r,t,n,a,o){void 0===o&&(o=Promise);var i=new m(c(r,t,n,a),o);return e.isGeneratorFunction(t)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(w),u(w,i,"Generator"),w[a]=function(){return this},w.toString=function(){return"[object Generator]"},e.keys=function(e){var r=[];for(var t in e)r.push(t);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=S,K.prototype={constructor:K,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&t.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(t,n){return i.type="throw",i.arg=e,r.next=t,n&&(r.method="next",r.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var u=t.call(o,"catchLoc"),c=t.call(o,"finallyLoc");if(u&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,r){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&t.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=r&&r<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=r,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(i)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),f},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.finallyLoc===e)return this.complete(t.completion,t.afterLoc),k(t),f}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.tryLoc===e){var n=t.completion;if("throw"===n.type){var a=n.arg;k(t)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,t){return this.delegate={iterator:S(e),resultName:r,nextLoc:t},"next"===this.method&&(this.arg=void 0),f}},e}(e.exports);try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}}(c={exports:{}}),c.exports),f="undefined"!=typeof window&&"undefined"==typeof jest?window.crypto.subtle:(new r.Crypto).subtle,p={"EC P-256":{name:"ECDSA",namedCurve:"P-256"},"EC P-384":{name:"ECDSA",namedCurve:"P-384"},"EC P-521":{name:"ECDSA",namedCurve:"P-521"},"RSASSA-PKCS1-v1_5 2048":{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:"SHA-256",publicExponent:new Uint8Array([1,0,1])}},y=function(){var e=i(s.mark((function e(r){var t;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.exportKey("jwk",r);case 2:return delete(t=e.sent).ext,delete t.key_ops,e.abrupt("return",u({kty:t.kty,crv:t.crv},t));case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),l=function(){var e=i(s.mark((function e(r){var t,n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.publicKey,n=r.privateKey,e.next=3,y(t);case 3:return e.t0=e.sent,e.next=6,y(n);case 6:return e.t1=e.sent,e.abrupt("return",{publicKeyJwk:e.t0,privateKeyJwk:e.t1});case 8:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),v=function(){var e=i(s.mark((function e(r){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.generateKey(r,!0,["sign","verify"]);case 2:return e.abrupt("return",l(e.sent));case 4:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),h=function(){var e=i(s.mark((function e(r){var t;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=p[r.kty+" "+r.crvOrSize],e.next=4,v(t);case 4:return e.abrupt("return",u({id:"",type:"JsonWebKey2020",controller:""},e.sent));case 8:throw e.prev=8,e.t0=e.catch(0),console.warn(e.t0),new Error("Unsupport generate options: "+JSON.stringify(r));case 12:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r){return e.apply(this,arguments)}}();function d(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),t=0;t<r.length;t++)r[t]=255;for(var n=0;n<e.length;n++){var a=e.charAt(n),o=a.charCodeAt(0);if(255!==r[o])throw new TypeError(a+" is ambiguous");r[o]=n}var i=e.length,u=e.charAt(0),c=Math.log(i)/Math.log(256),s=Math.log(256)/Math.log(i);function f(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return Buffer.alloc(0);var t=0;if(" "!==e[t]){for(var n=0,a=0;e[t]===u;)n++,t++;for(var o=(e.length-t)*c+1>>>0,s=new Uint8Array(o);e[t];){var f=r[e.charCodeAt(t)];if(255===f)return;for(var p=0,y=o-1;(0!==f||p<a)&&-1!==y;y--,p++)s[y]=(f+=i*s[y]>>>0)%256>>>0,f=f/256>>>0;if(0!==f)throw new Error("Non-zero carry");a=p,t++}if(" "!==e[t]){for(var l=o-a;l!==o&&0===s[l];)l++;var v=Buffer.allocUnsafe(n+(o-l));v.fill(0,0,n);for(var h=n;l!==o;)v[h++]=s[l++];return v}}}return{encode:function(r){if((Array.isArray(r)||r instanceof Uint8Array)&&(r=Buffer.from(r)),!Buffer.isBuffer(r))throw new TypeError("Expected Buffer");if(0===r.length)return"";for(var t=0,n=0,a=0,o=r.length;a!==o&&0===r[a];)a++,t++;for(var c=(o-a)*s+1>>>0,f=new Uint8Array(c);a!==o;){for(var p=r[a],y=0,l=c-1;(0!==p||y<n)&&-1!==l;l--,y++)f[l]=(p+=256*f[l]>>>0)%i>>>0,p=p/i>>>0;if(0!==p)throw new Error("Non-zero carry");n=y,a++}for(var v=c-n;v!==c&&0===f[v];)v++;for(var h=u.repeat(t);v<c;++v)h+=e.charAt(f[v]);return h},decodeUnsafe:f,decode:function(e){var r=f(e);if(r)return r;throw new Error("Non-base"+i+" character")}}}var w=d("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),b={encode:function(e){return Buffer.from(e||"").toString("base64")},decode:function(e){return Buffer.from(e||"","base64").toString("utf8")}},m={encode:function(e){return b.encode(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")},decode:function(e){for(e=e.replace(/-/g,"+").replace(/_/g,"/");e.length%4;)e+="=";return b.decode(e)}},g={__proto__:null,base58:w,base64:b,base64url:m};function x(e,r){for(var t=""+e;t.length<r;)t="0"+t;return t}var k,K=function(e){var r,t,n,a=Buffer.from(e).toString("hex"),o=a.slice(0,a.length/2),i=a.slice(a.length/2,a.length);return r=Uint8Array.from(Buffer.from(o,"hex")),t=Uint8Array.from(Buffer.from(i,"hex")),(n=new Uint8Array(r.length+1))[0]=2+(1&t[t.length-1]),n.set(r,1),n},S={"P-256":64,"P-384":96,"P-521":132},E=function(e,r){var n,a=Buffer.from(e).toString("hex"),o=function(e){var r,n,a,o;return"P-256"===e&&(o=(n=(r=new t(2)).pow(256).subtract(r.pow(224)).add(r.pow(192)).add(r.pow(96)).subtract(1)).add(1).divide(4),a=new t("5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b",16)),"P-384"===e&&(o=(n=(r=new t(2)).pow(384).subtract(r.pow(128)).subtract(r.pow(96)).add(r.pow(32)).subtract(1)).add(1).divide(4),a=new t("b3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef",16)),"P-521"===e&&(n=(r=new t(2)).pow(521).subtract(1),a=new t("00000051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00",16),o=n.add(1).divide(4)),{prime:n,b:a,pIdent:o}}(r),i=o.prime,u=o.b,c=o.pIdent,s=new Number(a[1])-2,f=new t(a.substring(2),16);return(n=f.pow(3).subtract(f.multiply(3)).add(u).modPow(c,i)).mod(2).toJSNumber()!==s&&(n=i.subtract(n)),Buffer.from(x(f.toString(16),S[r])+x(n.toString(16),S[r]),"hex")},J=JSON.stringify,P={"P-256":"8024","P-384":"8124","P-521":"8224"},A={8024:"P-256",8124:"P-384",8224:"P-521"},C=function(e){var r={z:w,u:m}[e[0]].decode(e.substring(1)),t=r.slice(0,2),n=r.slice(2),a=A[t.toString("hex")],o=E(n,a),i=o.slice(0,o.length/2),u=o.slice(o.length/2);return{kty:"EC",crv:a,x:m.encode(i),y:m.encode(u)}},B=function(){var e=i(s.mark((function e(r){var t;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return delete(t=u({},r)).d,delete t.kid,delete t.alg,e.next=6,f.digest("SHA-256",Buffer.from(J(t)));case 6:return e.abrupt("return",m.encode(e.sent));case 8:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),_=function(){var e=i(s.mark((function e(r){var t,n,a;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],r.x&&t.push(Buffer.from(r.x,"base64")),r.y&&t.push(Buffer.from(r.y,"base64")),n=Buffer.concat(t),a=Buffer.from(K(Uint8Array.from(n))),e.abrupt("return","z"+w.encode(Buffer.concat([Buffer.from(P[r.crv],"hex"),a])));case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),L=function(e,r){if(void 0===r&&(r=!1),"EC"===e.kty&&"P-256"===e.crv)return{name:r?"ECDH":"ECDSA",namedCurve:"P-256"};if("EC"===e.kty&&"P-384"===e.crv)return{name:r?"ECDH":"ECDSA",namedCurve:"P-384"};if("EC"===e.kty&&"P-521"===e.crv)return{name:r?"ECDH":"ECDSA",namedCurve:"P-521"};if("RSA"===e.kty)return{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:"SHA-256",publicExponent:new Uint8Array([1,0,1])};throw new Error("Unsupported jwk: "+JSON.stringify(e))},O=function(){var e=i(s.mark((function e(r,t){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=!1),r.privateKeyJwk){e.next=3;break}return e.abrupt("return",f.importKey("jwk",r.publicKeyJwk,L(r.publicKeyJwk,t),!0,t?[]:["verify"]));case 3:if(!r.privateKeyJwk){e.next=5;break}return e.abrupt("return",f.importKey("jwk",r.privateKeyJwk,L(r.privateKeyJwk,t),!0,t?["deriveBits"]:["sign"]));case 5:throw new Error("unsupported key type:  "+JSON.stringify(r));case 6:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),U=function(){var e=i(s.mark((function e(r,t){var n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=!1),n={},!r.publicKeyJwk){e.next=6;break}return e.next=5,O({publicKeyJwk:r.publicKeyJwk},t);case 5:n.publicKey=e.sent;case 6:if(!r.privateKeyJwk){e.next=10;break}return e.next=9,O({privateKeyJwk:r.privateKeyJwk},t);case 9:n.privateKey=e.sent;case 10:return e.abrupt("return",n);case 11:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),W={P256Key2021:"P-256",P384Key2021:"P-384",P521Key2021:"P-521"},D=function(e){var r={kty:"EC",crv:W[e.type]};if(e.publicKeyBase58){var t=w.decode(e.publicKeyBase58),n=E(Uint8Array.from(t),r.crv),a=n.slice(0,n.length/2),o=n.slice(n.length/2);r=u({},r,{x:m.encode(a),y:m.encode(o)})}var i={id:e.id,controller:e.controller,type:"JsonWebKey2020",publicKeyJwk:r};if(e.privateKeyBase58){var c=w.decode(e.privateKeyBase58);i.privateKeyJwk=u({},i.publicKeyJwk,{d:m.encode(c)})}return i},N=function(){var e=i(s.mark((function e(r,t){var n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=!1),e.prev=1,n=D(r),e.abrupt("return",U(n,t));case 6:throw e.prev=6,e.t0=e.catch(1),new Error("unsupported key type:  "+e.t0+"\n "+JSON.stringify(r));case 9:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(r,t){return e.apply(this,arguments)}}(),j={__proto__:null,getJwkFromCryptoKey:y,getCleanJwksFromCryptoKeyPair:l,generate:h,getJwkFromMulticodec:C,getKid:B,getMulticodec:_,getCryptoKeyFromJsonWebKey2020:O,getCryptoKeyPairFromJsonWebKey2020:U,getCryptoKeyPairFromMultiKey2021:N},F=function(e){if("ECDSA"===e.algorithm.name&&"P-256"===e.algorithm.namedCurve)return{name:"ECDSA",hash:"SHA-256"};if("ECDSA"===e.algorithm.name&&"P-384"===e.algorithm.namedCurve)return{name:"ECDSA",hash:"SHA-384"};if("ECDSA"===e.algorithm.name&&"P-521"===e.algorithm.namedCurve)return{name:"ECDSA",hash:"SHA-512"};if("RSASSA-PKCS1-v1_5"===e.algorithm.name)return"RSASSA-PKCS1-v1_5";throw new Error("Unsupported cryptoKey: "+JSON.stringify(e))},H=function(e){return{sign:(r=i(s.mark((function r(t){var n,a;return s.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(n=t.data,a=e,"JsonWebKey2020"!==e.type){r.next=6;break}return r.next=5,O(e);case 5:a=r.sent;case 6:return r.next=8,f.sign(F(a),a,Buffer.from(n));case 8:return r.abrupt("return",new Uint8Array(r.sent));case 10:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})};var r},R=function(e,r){return void 0===r&&(r={ignorePrivateKey:!1}),{verify:(t=i(s.mark((function t(n){var a,o,i,u;return s.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=n.signature,o=n.data,i=e,"JsonWebKey2020"!==e.type){t.next=9;break}if(!e.privateKeyJwk){t.next=6;break}if(r.ignorePrivateKey){t.next=6;break}throw new Error("verification method contained private key!");case 6:return t.next=8,O(e);case 8:i=t.sent;case 9:return u=!1,t.prev=10,t.next=13,f.verify(F(i),i,a,o);case 13:u=t.sent,t.next=18;break;case 16:t.prev=16,t.t0=t.catch(10);case 18:return t.abrupt("return",u);case 19:case"end":return t.stop()}}),t,null,[[10,16]])}))),function(e){return t.apply(this,arguments)})};var t},T={__proto__:null,getSigner:H,getVerifier:R},G=JSON.stringify,M=function(){var e=i(s.mark((function e(r,t,n){var a,o,i;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=m.encode(G(n)),o=m.encode("string"==typeof t?t:G(t)),i=a+"."+o,e.next=5,r.sign({data:i});case 5:return e.abrupt("return",i+"."+m.encode(Buffer.from(e.sent)));case 7:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}(),z=function(){var e=i(s.mark((function e(r,t){var n,a,o;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.split("."),a=n[2],o=n[0]+"."+n[1],e.next=4,r.verify({data:Buffer.from(o),signature:Buffer.from(a,"base64")});case 4:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),q=function(){var e=i(s.mark((function e(r,t,n){var a,o,i;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=m.encode(G(u({},n,{b64:!1,crit:["b64"]}))),o=new Uint8Array(Buffer.concat([Buffer.from(a,"utf-8"),Buffer.from(".","utf-8"),t])),e.next=4,r.sign({data:o});case 4:return i=m.encode(Buffer.from(e.sent)),e.abrupt("return",a+".."+i);case 7:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}(),I=function(){var e=i(s.mark((function e(r,t,n){var a,o,i;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.split(".."),o=a[1],i=new Uint8Array(Buffer.concat([Buffer.from(a[0],"utf-8"),Buffer.from(".","utf-8"),t])),e.next=4,r.verify({data:i,signature:Buffer.from(o,"base64")});case 4:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}(),V=function(){var e=i(s.mark((function e(r){var t,n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=F(r),n="none","RSASSA-PKCS1-v1_5"===t&&(n="RS256"),"ECDSA"===t.name&&"SHA-256"===t.hash&&(n="ES256"),"ECDSA"===t.name&&"SHA-384"===t.hash&&(n="ES384"),"ECDSA"===t.name&&"SHA-512"===t.hash&&(n="ES512"),"none"!==n){e.next=10;break}throw new Error("Unsupported signature alg: "+n);case 10:return e.abrupt("return",n);case 11:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),Y={__proto__:null,getJwaAlgFromJwk:function(e){if("EC"===e.kty&&"P-256"===e.crv)return"ES256";if("EC"===e.kty&&"P-384"===e.crv)return"ES384";if("EC"===e.kty&&"P-521"===e.crv)return"ES512";if("RSA"===e.kty)return"RS256";throw new Error("Unsupported getJwaAlgFromJwk for jwk: "+JSON.stringify(e))},createJws:M,verifyJws:z,createDetachedJws:q,verifyDetachedJws:I,getJwsSigner:function(e){return{sign:(r=i(s.mark((function r(t){var n,a;return s.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.data,a=H(e),r.next=4,V(e);case 4:return r.abrupt("return",M(a,n,{alg:r.sent}));case 6:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})};var r},getDetachedJwsSigner:function(e){return{sign:(r=i(s.mark((function r(t){var n,a;return s.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.data,a=H(e),r.next=4,V(e);case 4:return r.abrupt("return",q(a,n,{alg:r.sent}));case 6:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})};var r},getJwsVerifier:function(e){return{verify:(r=i(s.mark((function r(t){var n,a;return s.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.signature,a=R(e),r.abrupt("return",z(a,n));case 3:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})};var r},getDetachedJwsVerifier:function(e){return{verify:(r=i(s.mark((function r(t){var n,a,o;return s.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.data,a=t.signature,o=R(e),r.abrupt("return",I(o,n,a));case 3:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})};var r}},Q=function(){var e=i(s.mark((function e(r,t){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=Uint8Array,e.next=3,f.deriveBits({name:"ECDH",public:t},r,256);case 3:return e.t1=e.sent,e.abrupt("return",new e.t0(e.t1));case 5:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),X=function(){var e=i(s.mark((function e(r,t){var n,a;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("RSA"!==r.privateKeyJwk.kty){e.next=2;break}throw new Error("deriveBits is not supported on this key type");case 2:return e.next=4,O({publicKeyJwk:u({},r.publicKeyJwk),privateKeyJwk:u({},r.privateKeyJwk,{usages:["deriveKey","deriveBits"]})},!0);case 4:return n=e.sent,e.next=7,O({publicKeyJwk:t.publicKeyJwk},!0);case 7:if(a=e.sent,t.publicKeyJwk.kty===r.privateKeyJwk.kty){e.next=10;break}throw new Error("local and remote kty must match: "+t.publicKeyJwk.kty+" "+r.privateKeyJwk.kty);case 10:return e.t0=Uint8Array,e.next=13,f.deriveBits({name:"ECDH",public:a},n,256);case 13:return e.t1=e.sent,e.abrupt("return",new e.t0(e.t1));case 15:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),Z=function(){var e=i(s.mark((function e(r,t,n,a){var o;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r,e.t1=t,e.next=4,y(n);case 4:if(e.t2=e.sent,o={id:e.t0,type:"JsonWebKey2020",controller:e.t1,publicKeyJwk:e.t2},!a){e.next=16;break}return e.prev=7,e.next=10,y(a);case 10:o.privateKeyJwk=e.sent,e.next=16;break;case 13:throw e.prev=13,e.t3=e.catch(7),new Error("Cannot export private key");case 16:return e.abrupt("return",o);case 17:case"end":return e.stop()}}),e,null,[[7,13]])})));return function(r,t,n,a){return e.apply(this,arguments)}}(),$=function(){var e=i(s.mark((function e(r,t,n,a,o){var i,u,c;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(a);case 2:if(i=e.sent,!o){e.next=9;break}return e.next=6,y(o);case 6:e.t0=e.sent,e.next=10;break;case 9:e.t0=void 0;case 10:return u=e.t0,c={id:r,type:t,controller:n,publicKeyBase58:w.encode(K(Buffer.concat([Buffer.from(i.x,"base64"),Buffer.from(i.y,"base64")])))},u&&(c.privateKeyBase58=w.encode(Buffer.from(u.d,"base64"))),e.abrupt("return",c);case 14:case"end":return e.stop()}}),e)})));return function(r,t,n,a,o){return e.apply(this,arguments)}}(),ee={JsonWebKey2020:Z,P521Key2021:function(){var e=i(s.mark((function e(r,t,n,a){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",$(r,"P521Key2021",t,n,a));case 1:case"end":return e.stop()}}),e)})));return function(r,t,n,a){return e.apply(this,arguments)}}(),P384Key2021:function(){var e=i(s.mark((function e(r,t,n,a){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",$(r,"P384Key2021",t,n,a));case 1:case"end":return e.stop()}}),e)})));return function(r,t,n,a){return e.apply(this,arguments)}}(),P256Key2021:function(){var e=i(s.mark((function e(r,t,n,a){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",$(r,"P256Key2021",t,n,a));case 1:case"end":return e.stop()}}),e)})));return function(r,t,n,a){return e.apply(this,arguments)}}()};exports.WebCryptoKey=k=function(){function e(e){this.type="JsonWebKey2020",this.id=e.id,this.type=e.type||"JsonWebKey2020",this.controller=e.controller,this.publicKey=e.publicKey,this.privateKey=e.privateKey}e.fingerprintFromPublicKey=function(){var e=i(s.mark((function e(r){var t;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,k.from(r);case 2:return t=e.sent,e.next=5,t;case 5:return e.abrupt("return",e.sent.fingerprint());case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e.fromFingerprint=function(){var e=i(s.mark((function e(r){var t,n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.fingerprint,e.prev=1,n=C(t),e.abrupt("return",k.from({id:"did:key:"+t+"#"+t,type:"JsonWebKey2020",controller:"did:key:"+t,publicKeyJwk:n}));case 6:throw e.prev=6,e.t0=e.catch(1),new Error("Unsupported fingerprint type: "+t);case 9:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(r){return e.apply(this,arguments)}}();var r=e.prototype;return r.fingerprint=function(){var e=i(s.mark((function e(){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=_,e.next=3,y(this.publicKey);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.export=function(){var e=i(s.mark((function e(r){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===r&&(r={privateKey:!1,type:"JsonWebKey2020"}),!ee[r.type]){e.next=3;break}return e.abrupt("return",ee[r.type](this.id,this.controller,this.publicKey,r.privateKey?this.privateKey:void 0));case 3:throw new Error("Unsupported export options: "+JSON.stringify(r));case 4:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),r.signer=function(e){if(void 0===e&&(e="Ecdsa"),this.privateKey)return H(this.privateKey);throw new Error("No private key to sign "+e+" with.")},r.verifier=function(e){if(void 0===e&&(e="Ecdsa"),this.publicKey)return R(this.publicKey);throw new Error("No public key to verify "+e+" with.")},r.deriveSecret=function(){var e=i(s.mark((function e(r){var t,n,a;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.publicKey,this.privateKey){e.next=3;break}throw new Error("private key is required to deriveSecret");case 3:if(a=this.privateKey,null==(t=this.privateKey)||!t.extractable){e.next=12;break}return e.t0=j,e.next=8,this.export({type:"JsonWebKey2020",privateKey:!0});case 8:return e.t1=e.sent,e.next=11,e.t0.getCryptoKeyPairFromJsonWebKey2020.call(e.t0,e.t1,!0);case 11:a=e.sent.privateKey;case 12:if("JsonWebKey2020"!==n.type){e.next=18;break}return e.next=15,U(n,!0);case 15:e.t2=e.sent,e.next=21;break;case 18:return e.next=20,N(n,!0);case 20:e.t2=e.sent;case 21:return e.abrupt("return",Q(a,e.t2.publicKey));case 23:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e}(),exports.WebCryptoKey.generate=function(){var e=i(s.mark((function e(r){var t,n,a;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===r&&(r={kty:"EC",crvOrSize:"P-384"}),e.next=3,h(r);case 3:return t=e.sent,e.next=6,k.fingerprintFromPublicKey({id:"",type:"JsonWebKey2020",controller:"",publicKeyJwk:t.publicKeyJwk});case 6:return n=e.sent,e.next=9,U(t);case 9:return e.abrupt("return",new k({id:"did:key:"+n+"#"+n,type:"JsonWebKey2020",controller:"did:key:"+n,publicKey:(a=e.sent).publicKey,privateKey:a.privateKey}));case 13:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),exports.WebCryptoKey.from=function(){var e=i(s.mark((function e(r){var t,n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("JsonWebKey2020"!==r.type){e.next=7;break}return e.next=3,U(r);case 3:return e.abrupt("return",new k({id:r.id,type:"JsonWebKey2020",controller:r.controller,publicKey:(t=e.sent).publicKey,privateKey:t.privateKey}));case 7:return e.next=9,N(r);case 9:return e.abrupt("return",new k({id:r.id,type:r.type,controller:r.controller,publicKey:(n=e.sent).publicKey,privateKey:n.privateKey}));case 13:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),exports.WebCryptoKey=k=n.__decorate([a.staticImplements()],exports.WebCryptoKey),exports.deriveBitsFromCryptoKey=Q,exports.deriveBitsFromJsonWebKey2020=X,exports.encoding=g,exports.jws=Y,exports.key=j,exports.raw=T,exports.subtle=f;
//# sourceMappingURL=web-crypto-key-pair.cjs.production.min.js.map
